<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/login.css">
  <title>Login</title>
  <script src="./js/script.js"></script>
  <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.freepik.com/512/2983/2983665.png">
</head>

<body id="login">
  <div class="container">
    <div class="form-container">
      <hgroup>
        <h1>Bienvenido de vuelta</h1>
        <h2>Inicia sesión para continuar</h2>
      </hgroup>

      <form action="#" method="post" id="login-form">
        <div class="input-group">
          <label for="username">Correo electrónico</label>
          <input type="email" id="username" name="username" placeholder="Ingresa tu correo" required>
        </div>

        <div class="input-group">
          <label for="password">Contraseña</label>
          <input type="password" id="password" name="password" placeholder="Ingresa tu contraseña" required>
        </div>

        <button class="button" id="btn-submit" type="submit">
          Iniciar sesión
        </button>

        <div class="register-link">
          <p>¿No tienes cuenta? <a href="./register.html">Crea una aquí.</a></p>
        </div>
      </form>
    </div>

    <div class="background">
      <img src="https://cdn.pixabay.com/photo/2017/05/18/20/16/truck-2322281_1280.jpg" alt="Camión en la carretera">
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const loginForm = document.getElementById('login-form');

      loginForm.addEventListener('submit', event => {
        event.preventDefault();

        const username = loginForm.username.value;
        const password = loginForm.password.value;

        // Hash de la contraseña
        crypto.subtle.digest('SHA-256', new TextEncoder().encode(password))
          .then(hashBuffer => {
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(byte => byte.toString(16).padStart(2, '0')).join('');
            const hashedPassword = hashHex;

            // Hacer una solicitud para verificar las credenciales del usuario
            fetch('http://localhost:3001/login')
              .then(response => response.json())
              .then(data => {
                // Verificar si las credenciales son correctas
                const user = data.find(user => user.username === username && user.password === hashedPassword);
                if (user) {
                  // Credenciales correctas, almacenar el nombre de usuario en el localStorage
                  localStorage.setItem('username', username);
                  localStorage.setItem('token', 'token_de_sesion_generado');
                  window.location.href = 'backend.html';
                } else {
                  // Credenciales incorrectas, mostrar un mensaje de error
                  alert('Credenciales incorrectas. Por favor, inténtelo de nuevo.');
                }
              })
              .catch(error => {
                console.error('Error al verificar las credenciales:', error);
                alert('Ha ocurrido un error al intentar iniciar sesión. Por favor, inténtelo de nuevo más tarde.');
              });
          })
          .catch(error => console.error('Error al cifrar la contraseña:', error));
      });
    });
  </script>
</body>

</html>
